<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Algebra 2 Tutor — Polynomials</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ink:#111; --muted:#667085; --bg:#0b0f14; --card:#0f1520; --accent:#7c9cff; --good:#31c48d; --bad:#ef4444; --warn:#f59e0b; --chip:#1c2330;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:#e5e7eb;font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;}
    a{color:var(--accent);text-decoration:none}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(15,21,32,.95), rgba(15,21,32,.7));backdrop-filter: blur(6px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1050px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0;color:#fff}
    .sub{color:#9ca3af;font-size:13px}
    main{max-width:1050px;margin:18px auto;padding:16px;display:grid;gap:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:980px){.grid{grid-template-columns:280px 1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:16px}
    .chip{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid #273044;padding:4px 10px;border-radius:999px;font-size:12px;color:#cbd5e1}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .muted{color:#9aa3b2}
    .btn{appearance:none;border:0;background:#2b3547;color:#e5e7eb;padding:10px 14px;border-radius:12px;cursor:pointer;border:1px solid #39455e}
    .btn:hover{background:#344158}
    .btn.primary{background:var(--accent);border-color:#6a87ff;color:#0b1020;font-weight:700}
    .btn.ghost{background:transparent}
    .ok{color:var(--good)} .bad{color:#fecaca}
    .warn{color:var(--warn)}
    .hidden{display:none}
    .hr{height:1px;background:#1f2937;margin:12px 0}
    .step{padding:12px;border-radius:12px;background:#0c1220;border:1px dashed #22304a;margin-top:8px}
    input[type="text"], input[type="number"], select{
      background:#0c1220;color:#e5e7eb;border:1px solid #22304a;border-radius:10px;padding:8px 10px;min-width:80px
    }
    kbd{background:#0c1220;border:1px solid #22304a;padding:2px 6px;border-radius:6px}
    .progress{height:8px;background:#111827;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:var(--accent);width:0%}
    .badge{font-size:11px;background:#12203a;border:1px solid #243b66;padding:3px 8px;border-radius:999px}
    .tiny{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .correct{outline:2px solid var(--good)}
    .incorrect{outline:2px solid var(--bad)}
    details{background:#0c1220;border:1px solid #22304a;border-radius:10px;padding:10px}
    summary{cursor:pointer}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;border:1px solid #1f2937;border-radius:12px;padding:10px 14px}
  </style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between;align-items:center">
    <div>
      <h1>Algebra 2 Tutor — Polynomials</h1>
      <div class="sub">Guided, step-by-step. Progress auto-saves.</div>
    </div>
    <div class="row">
      <span class="chip">Mode: <strong id="modeLabel">Learn</strong></span>
      <button class="btn" id="toggleMode" title="Switch between Learn/Practice">Switch</button>
    </div>
  </div>
</header>

<main class="grid">
  <!-- Left: Module Nav -->
  <aside class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>Modules</strong>
      <span class="badge tiny" id="overallPct">0% Complete</span>
    </div>
    <div class="hr"></div>
    <nav id="nav"></nav>
    <div class="hr"></div>
    <details>
      <summary>Study tips</summary>
      <ul class="tiny">
        <li>Rewrite in <em>standard form</em> before combining or comparing.</li>
        <li>On subtraction, distribute the <span class="mono">−1</span>.</li>
        <li>Multiply? Every term × every term. Track degree and coefficient.</li>
        <li>Binomial Theorem: coefficients are \( \\binom{n}{r} \ ); signs alternate if the binomial has a minus.</li>
        <li>Factoring: try GCF → special pattern → grouping.</li>
      </ul>
    </details>
  </aside>

  <!-- Right: Workspace -->
  <section class="card" id="workspace">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="chip" id="unitTag">Unit</div>
        <h2 id="unitTitle" style="margin:8px 0 4px 0">Loading…</h2>
        <div class="muted tiny" id="unitSub">—</div>
      </div>
      <div style="min-width:240px">
        <div class="progress"><div class="bar" id="unitBar"></div></div>
        <div class="tiny muted" style="margin-top:6px"><span id="unitCount">0</span> steps done</div>
      </div>
    </div>
    <div class="hr"></div>
    <div id="steps"></div>
    <div class="hr"></div>
    <div class="row">
      <button class="btn ghost" id="resetUnit">Reset this module</button>
      <button class="btn primary" id="nextStep">Next ▶</button>
    </div>
    <p class="tiny muted" style="margin-top:8px">
      This app mirrors a standard Algebra 2 “Polynomials” sequence: add/subtract, multiply, binomial theorem, factoring.
    </p>
  </section>
</main>

<div class="toast hidden" id="toast"></div>

<script>
/* ====== tiny DOM helpers & state ====== */
const $ = sel => document.querySelector(sel);
const nav = $("#nav");
const stepsBox = $("#steps");
const unitTitle = $("#unitTitle");
const unitSub = $("#unitSub");
const unitTag = $("#unitTag");
const unitBar = $("#unitBar");
const unitCount = $("#unitCount");
const overallPct = $("#overallPct");
const nextBtn = $("#nextStep");
const resetBtn = $("#resetUnit");
const toast = $("#toast");
const toggleModeBtn = $("#toggleMode");
const modeLabel = $("#modeLabel");

let MODE = localStorage.getItem("mode") || "Learn"; // Learn | Practice
modeLabel.textContent = MODE;

toggleModeBtn.onclick = () => {
  MODE = MODE === "Learn" ? "Practice" : "Learn";
  localStorage.setItem("mode", MODE);
  modeLabel.textContent = MODE;
  notify(\`Switched to \${MODE} mode\`);
};

function notify(msg){
  toast.textContent = msg;
  toast.classList.remove("hidden");
  setTimeout(()=>toast.classList.add("hidden"), 1400);
}
function saveProgress(){
  localStorage.setItem("a2tutor-progress", JSON.stringify(progress));
  updateOverall();
}
function loadProgress(){
  try{ return JSON.parse(localStorage.getItem("a2tutor-progress")) || {}; }
  catch{ return {}; }
}
const progress = loadProgress();

/* ====== general math helpers ====== */
function stdPoly(terms){
  const map = new Map();
  for(const t of terms){ map.set(t.pow, (map.get(t.pow)||0) + t.coef); }
  const arr = [...map.entries()].map(([pow,coef])=>({pow,coef})).sort((a,b)=>b.pow-a.pow);
  return arr.filter(t=>Math.abs(t.coef)>1e-9);
}
function formatPoly(terms){
  if(!terms.length) return "0";
  return terms.map((t,i)=>{
    const c=t.coef, p=t.pow;
    const sign = c<0 ? " − " : (i===0?"":" + ");
    const abs = Math.abs(c);
    if(p===0) return \`\${sign}\${abs}\`;
    if(p===1){ return \`\${sign}\${abs===1? "x" : abs+"x"}\`; }
    return \`\${sign}\${abs===1? "x" : abs+"x"}<sup>\${p}</sup>\`;
  }).join("").trim().replace(/^\+ /,'').replace(/^− /,'− ');
}
function nCr(n,r){
  if(r<0||r>n) return 0;
  r = Math.min(r, n-r);
  let num=1, den=1;
  for(let i=1;i<=r;i++){ num*= (n-(r-i)); den*=i; }
  return Math.round(num/den);
}

/* ====== robust ASCII poly parse/compare (used in validators & quizzes) ====== */
function formatPolyAscii(terms){
  if(!terms.length) return "0";
  return terms.map((t,i)=>{
    const c=t.coef, p=t.pow;
    const sign = c<0 ? " - " : (i===0?"": " + ");
    const abs = Math.abs(c);
    if(p===0) return \`\${sign}\${abs}\`;
    if(p===1) return \`\${sign}\${abs===1?"":"\${abs}"}x\`.replace(" 1x"," x");
    return \`\${sign}\${abs===1?"":"\${abs}"}x^\${p}\`.replace(" 1x"," x");
  }).join("").replace(/^\s\+\s/,'').replace(/^\s-\s/,'-');
}
const R = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
const pick = arr => arr[R(0,arr.length-1)];
const small = (nonzero=true)=>{ let v=R(-6,6); if(nonzero && v===0) v=1; return v; };
function poly(...terms){
  const map = new Map();
  for(const [c,p] of terms){ map.set(p, (map.get(p)||0)+c); }
  const arr=[...map.entries()].map(([pow,coef])=>({pow,coef}))
    .filter(t=>Math.abs(t.coef)>1e-9).sort((a,b)=>b.pow-a.pow);
  return arr;
}
function parsePolyAscii(str){
  if(!str || typeof str!=="string") return null;
  const s = str.replace(/\s+/g,'').replace(/–/g,'-').toLowerCase();
  const parts = s.replace(/^\+/,'').replace(/-/g,'±-').replace(/\+/g,'±+').split('±').filter(Boolean);
  const terms=[];
  for(const part0 of parts){
    let t = part0;
    let sign = 1;
    if(t[0]==='-'){ sign=-1; t=t.slice(1); }
    if(t[0]==='+'){ sign=+1; t=t.slice(1); }
    if(t.includes('x')){
      const [coefStr, rest] = t.split('x');
      let coef = coefStr==='' ? 1 : Number(coefStr);
      if(Number.isNaN(coef)) return null;
      let pow = 1;
      if(rest && rest.startsWith('^')){
        pow = Number(rest.slice(1));
        if(Number.isNaN(pow)) return null;
      }
      terms.push([sign*coef, pow]);
    }else{
      const c = Number(t);
      if(Number.isNaN(c)) return null;
      terms.push([sign*c, 0]);
    }
  }
  return poly(...terms);
}
function samePoly(studentStr, expectedTerms){
  const got = parsePolyAscii(studentStr);
  if(!got) return false;
  const a = formatPolyAscii(got);
  const b = formatPolyAscii(expectedTerms);
  return a.replace(/\s+/g,'') === b.replace(/\s+/g,'');
}
function nudgeTerms(terms){ return terms.map(t=>({coef:t.coef+pick([-2,-1,1,2]), pow:t.pow})); }
function flipSignOne(terms){ const idx=R(0,terms.length-1); return terms.map((t,i)=> i===idx?{coef:-t.coef,pow:t.pow}:t); }

/* ====== step builders ====== */
function stepInfo(html){ const d=document.createElement("div"); d.className="step"; d.innerHTML=html; return {el:d, check:null}; }
function stepInput(label, placeholder, validator, hintHtml){
  const d=document.createElement("div");
  d.className="step";
  d.innerHTML = \`
    <div class="row"><strong>\${label}</strong></div>
    <div class="row" style="margin-top:8px">
      <input type="text" id="ans" placeholder="\${placeholder}" />
      <button class="btn" id="check">Check</button>
      <span id="msg" class="tiny muted"></span>
    </div>
    \${hintHtml? \`<details style="margin-top:10px"><summary>Hint</summary><div class="tiny">\${hintHtml}</div></details>\` : ""}
  \`;
  const ans = d.querySelector("#ans");
  const msg = d.querySelector("#msg");
  const btn = d.querySelector("#check");
  let passed = false;
  btn.onclick = ()=>{
    const res = validator(ans.value);
    if(res===true){ msg.textContent="nice — that’s correct"; msg.className="tiny ok"; ans.classList.remove("incorrect"); ans.classList.add("correct"); passed=true; notify("✓ step cleared"); }
    else { msg.textContent = res || "not quite — try again"; msg.className="tiny bad"; ans.classList.remove("correct"); ans.classList.add("incorrect"); }
  };
  return {el:d, check:()=>passed};
}
function stepMultiInputs(config){
  const d=document.createElement("div"); d.className="step"; d.innerHTML = \`<div><strong>\${config.title}</strong></div>\`;
  config.fields.forEach((f,i)=>{
    const row=document.createElement("div");
    row.className="row"; row.style.marginTop="8px";
    row.innerHTML = \`<label class="tiny muted" style="width:220px">\${i+1}. \${f.label}</label>
      <input type="text" data-key="\${f.key}" placeholder="\${f.placeholder||''}"/>
      <span class="tiny muted" id="m-\${i}"></span>\`;
    d.appendChild(row);
  });
  const btnRow=document.createElement("div");
  btnRow.className="row"; btnRow.style.marginTop="10px";
  btnRow.innerHTML = \`<button class="btn" id="check">Check</button> <span class="tiny muted" id="msg"></span>\`;
  d.appendChild(btnRow);
  const btn = d.querySelector("#check");
  const msg = d.querySelector("#msg");
  let passed=false;
  btn.onclick=()=>{
    let all=true;
    const inputs=[...d.querySelectorAll('input[data-key]')];
    inputs.forEach((inp,idx)=>{
      const f=config.fields[idx];
      const ok=f.validate(inp.value);
      const m=d.querySelector(\`#m-\${idx}\`);
      if(ok===true){ inp.classList.add("correct"); inp.classList.remove("incorrect"); m.textContent="✓"; m.className="tiny ok"; }
      else{ inp.classList.add("incorrect"); inp.classList.remove("correct"); m.textContent=(ok||""); m.className="tiny bad"; all=false; }
    });
    if(all){ msg.textContent = config.onPassNote || "Clean."; msg.className="tiny ok"; passed=true; notify("✓ step cleared"); }
    else { msg.textContent = "Some entries need love."; msg.className="tiny bad"; }
  };
  return {el:d, check:()=>passed};
}

/* ====== Question factories for Adaptive Quiz ====== */
function qL1(){
  const a=small(), b=small(), c=small(), d=small(), e=small(), f=small();
  const A = poly([a,2],[b,1],[c,0],[d,2],[e,1],[f,0]);
  const prompt = \`Combine like terms: (\${formatPolyAscii(poly([a,2],[b,1],[c,0]))}) + (\${formatPolyAscii(poly([d,2],[e,1],[f,0]))})\`;
  const correct = A;
  const ans = formatPolyAscii(correct);
  const wrong1 = formatPolyAscii(nudgeTerms(correct));
  const wrong2 = formatPolyAscii(flipSignOne(correct));
  const wrong3 = formatPolyAscii(poly([a+d,2],[b+e,1],[c-f,0]));
  const choices = [ans, wrong1, wrong2, wrong3].sort(()=>Math.random()-0.5);
  const correctIndex = choices.indexOf(ans);
  const breakdown = [
    \`Group x^2: \${a}+\${d} = \${a+d}\`,
    \`Group x: \${b}+\${e} = \${b+e}\`,
    \`Constants: \${c}+\${f} = \${c+f}\`,
    \`Final: \${ans}\`
  ];
  return {level:1, prompt, choices, correctIndex, breakdown, expected:correct};
}
function qL2(){
  const m=small(), n=small(), p=small();
  const prompt = \`Multiply: (x \${m>=0?'+':'-'} \${Math.abs(m)})(\${n}x \${p>=0?'+':'-'} \${Math.abs(p)})\`;
  const correct = poly([n,2],[p+m*n,1],[m*p,0]);
  const ans = formatPolyAscii(correct);
  const wrong1 = formatPolyAscii(poly([n,2],[p-m*n,1],[m*p,0]));
  const wrong2 = formatPolyAscii(poly([n,2],[p+m*n,1],[m+p,0]));
  const wrong3 = formatPolyAscii(poly([n,2],[p,1],[m*p,0]));
  const choices = [ans, wrong1, wrong2, wrong3].sort(()=>Math.random()-0.5);
  const correctIndex = choices.indexOf(ans);
  const breakdown = [
    \`FOIL: First → x·\${n}x = \${n}x^2\`,
    \`Outer → x·\${p} = \${p}x\`,
    \`Inner → \${m}·\${n}x = \${m*n}x\`,
    \`Last → \${m}·\${p} = \${m*p}\`,
    \`Combine middle: \${p}x + \${m*n}x = \${(p+m*n)}x\`,
    \`Final: \${ans}\`
  ];
  return {level:2, prompt, choices, correctIndex, breakdown, expected:correct};
}
function qL3(){
  const a = Math.abs(small());
  const minus = Math.random()<0.5;
  const prompt = \`Expand: (x \${minus?'-':'+'} \${a})^3\`;
  const c2 = 3*a*(minus?-1:1);
  const c1 = 3*a*a;
  const c0 = (minus?-1:1)*a*a*a;
  const correct = poly([1,3],[c2,2],[c1,1],[c0,0]);
  const ans = formatPolyAscii(correct);
  const wrong1 = formatPolyAscii(poly([1,3],[c2,2],[a*a,1],[c0,0]));
  const wrong2 = formatPolyAscii(poly([1,3],[-c2,2],[c1,1],[-c0,0]));
  const wrong3 = formatPolyAscii(nudgeTerms(correct));
  const choices = [ans, wrong1, wrong2, wrong3].sort(()=>Math.random()-0.5);
  const correctIndex = choices.indexOf(ans);
  const breakdown = [
    \`Coefficients row 3: 1, 3, 3, 1\`,
    \`Signs \${minus?'alternate (−)':'stay positive (+)'}\`,
    \`x^3 term = x^3\`,
    \`x^2 term = 3·\${a}·x^2 = \${c2}x^2\`,
    \`x term = 3·\${a}^2·x = \${c1}x\`,
    \`constant = \${minus?'-':''}\${a}^3 = \${c0}\`,
    \`Final: \${ans}\`
  ];
  return {level:3, prompt, choices, correctIndex, breakdown, expected:correct};
}
function qL4(){
  const type = pick(["gcf","dos","trin"]);
  if(type==="gcf"){
    const g = Math.abs(small());
    const a = g*R(1,5), b = g*R(1,5);
    const prompt = \`Factor completely: \${a}x^3 + \${b}x\`;
    const correct = \`(\${g}x) (\${formatPolyAscii(poly([a/g,2],[b/g,0]))})\`.replace(/\s+/g,' ').trim();
    const wrong1 = \`(\${g}) (\${formatPolyAscii(poly([a/g,3],[b/g,1]))})\`;
    const wrong2 = \`(\${g}x) (\${formatPolyAscii(poly([a/g,3],[b/g,1]))})\`;
    const wrong3 = \`(\${g}) (\${formatPolyAscii(poly([a/g,2],[b/g,0]))})\`;
    const choices = [correct, wrong1, wrong2, wrong3].sort(()=>Math.random()-0.5);
    return { level:4, prompt, choices, correctIndex:choices.indexOf(correct),
      breakdown:[ \`GCF in \${a}x^3 + \${b}x is \${g}x\`, \`Pull it out: \${g}x (\${a/g}x^2 + \${b/g})\`, \`Final: \${correct}\` ], expected:null };
  }
  if(type==="dos"){
    const k = R(2,6);
    const prompt = \`Factor: x^2 − \${k*k}\`;
    const correct = \`(x - \${k})(x + \${k})\`;
    const wrong1 = \`(x - \${k})^2\`;
    const wrong2 = \`(x + \${k})^2\`;
    const wrong3 = \`(x - \${k-1})(x + \${k+1})\`;
    const choices = [correct, wrong1, wrong2, wrong3].sort(()=>Math.random()-0.5);
    return { level:4, prompt, choices, correctIndex:choices.indexOf(correct),
      breakdown:[ \`Difference of squares: a^2 − b^2 = (a−b)(a+b)\`, \`Here a=x, b=\${k}\` ], expected:null };
  }
  const r1 = small(), r2 = small();
  const p = r1 + r2, q = r1 * r2;
  const prompt = \`Factor: x^2 \${p>=0?'+':'-'} \${Math.abs(p)}x \${q>=0?'+':'-'} \${Math.abs(q)}\`;
  const correct = \`(x \${r1>=0?'-':'+'} \${Math.abs(r1)})(x \${r2>=0?'-':'+'} \${Math.abs(r2)})\`;
  const wrong1 = \`(x \${r1>=0?'+':'-'} \${Math.abs(r1)})(x \${r2>=0?'+':'+'} \${Math.abs(r2)})\`;
  const wrong2 = \`(x \${r1>=0?'-':'+'} \${Math.abs(r1)})(x \${r2>=0?'+':'-'} \${Math.abs(r2+1)})\`;
  const wrong3 = \`(x \${r1>=0?'-':'+'} \${Math.abs(r1+1)})(x \${r2>=0?'+':'-'} \${Math.abs(r2)})\`;
  const choices = [correct, wrong1, wrong2, wrong3].sort(()=>Math.random()-0.5);
  return { level:4, prompt, choices, correctIndex:choices.indexOf(correct),
    breakdown:[ \`We want r1 + r2 = \${p} and r1·r2 = \${q}\`, \`Roots: \${r1}, \${r2} → factors (x−\${r1})(x−\${r2})\`, \`Final: \${correct}\` ], expected:null };
}
function makeQuestion(level){ if(level<=1) return qL1(); if(level===2) return qL2(); if(level===3) return qL3(); return qL4(); }

/* ====== Modules ====== */
const MODULES = [
  {
    id:"addsub",
    tag:"Lesson 6.1",
    title:"Add & Subtract Polynomials",
    sub:"Combine like terms. Standard form. Signs matter.",
    steps:[
      ()=>stepInfo(`<div><div class="badge">Concept</div><p class="tiny muted">A polynomial is a sum of monomials. To add/subtract, align powers and combine coefficients. Standard form = descending powers.</p></div>`),
      ()=>stepInput(
        "Rewrite in standard form: –2x + 6 + 3x^2 – x^3",
        "type the polynomial (use ^ for powers)",
        (v)=> samePoly(v, [{coef:-1,pow:3},{coef:3,pow:2},{coef:-2,pow:1},{coef:6,pow:0}]) || "Expected -x^3 + 3x^2 - 2x + 6",
        "Order by powers: x^3, x^2, x, constant. Keep signs with their terms."
      ),
      ()=>stepMultiInputs({
        title:"Subtract: (7a^3 − 4a^2 + 11) − (3a^2 − 2a + 5)",
        fields:[
          {label:"Distribute the minus: write the second polynomial after subtraction sign", key:"dist",
           placeholder:"…", validate:(v)=> samePoly(v, [{coef:-3,pow:2},{coef:2,pow:1},{coef:-5,pow:0}]) || "Should be −3a^2 + 2a − 5"},
          {label:"Combine like terms for a^3 coefficient", key:"a3", placeholder:"coefficient",
           validate:(v)=>Number(v)===7||"a^3 coefficient is 7"},
          {label:"Combine like terms for a^2 coefficient", key:"a2", placeholder:"coefficient",
           validate:(v)=>Number(v)===-7||"a^2 coefficient is −7"},
          {label:"Combine like terms for a coefficient", key:"a1", placeholder:"coefficient",
           validate:(v)=>Number(v)===2||"a coefficient is 2"},
          {label:"Constant term", key:"c", placeholder:"value",
           validate:(v)=>Number(v)===6||"Constant is 6"},
        ],
        onPassNote:"Final: 7a^3 − 7a^2 + 2a + 6"
      }),
      ()=>stepMultiInputs({
        title:"Add: (4x^2 − x^3 + 2 − x) + (−x + 6x^2 + 3x^4)",
        fields:[
          {label:"Write the sum in standard form", key:"sum",
            validate:(v)=> samePoly(v, [{coef:3,pow:4},{coef:-1,pow:3},{coef:10,pow:2},{coef:-2,pow:1},{coef:2,pow:0}]) || "Sum should be 3x^4 − x^3 + 10x^2 − 2x + 2" }
        ]
      }),
    ]
  },
  {
    id:"multiply",
    tag:"Lesson 6.2",
    title:"Multiply Polynomials",
    sub:"Distributive property: every term × every term. Track exponents.",
    steps:[
      ()=>stepInfo(`<div><div class="badge">Concept</div><p class="tiny muted">Two monomials: multiply coefficients and add exponents. Two binomials: distribute each term across the other binomial (FOIL is a shortcut). Vertical multiplication also works.</p></div>`),
      ()=>stepMultiInputs({
        title:"Multiply: (x + 2)(2x^2 − 4x + 1)",
        fields:[
          {label:"x × 2x^2", key:"p1", validate:(v)=> samePoly(v,[{coef:2,pow:3}]) || "2x^3"},
          {label:"x × (−4x)", key:"p2", validate:(v)=> samePoly(v,[{coef:-4,pow:2}]) || "−4x^2"},
          {label:"x × 1", key:"p3", validate:(v)=> samePoly(v,[{coef:1,pow:1}]) || "x"},
          {label:"2 × 2x^2", key:"p4", validate:(v)=> samePoly(v,[{coef:4,pow:2}]) || "4x^2"},
          {label:"2 × (−4x)", key:"p5", validate:(v)=> samePoly(v,[{coef:-8,pow:1}]) || "−8x"},
          {label:"2 × 1", key:"p6", validate:(v)=> samePoly(v,[{coef:2,pow:0}]) || "2"},
          {label:"Combine like terms → final", key:"f", validate:(v)=> samePoly(v, [{coef:2,pow:3},{coef:-7,pow:1},{coef:2,pow:0}]) || "Should be 2x^3 − 7x + 2"}
        ],
        onPassNote:"Locked ✅"
      }),
      ()=>stepMultiInputs({
        title:"FOIL: (3x − 4)(x + 2)",
        fields:[
          {label:"First (3x)(x)", key:"f", validate:(v)=> samePoly(v,[{coef:3,pow:2}]) || "3x^2"},
          {label:"Outer (3x)(2)", key:"o", validate:(v)=> samePoly(v,[{coef:6,pow:1}]) || "6x"},
          {label:"Inner (−4)(x)", key:"i", validate:(v)=> samePoly(v,[{coef:-4,pow:1}]) || "−4x"},
          {label:"Last (−4)(2)", key:"l", validate:(v)=> samePoly(v,[{coef:-8,pow:0}]) || "−8"},
          {label:"Combine like terms → final", key:"fin", validate:(v)=> samePoly(v,[{coef:3,pow:2},{coef:2,pow:1},{coef:-8,pow:0}]) || "Final is 3x^2 + 2x − 8"},
        ]
      }),
    ]
  },
  {
    id:"binomial",
    tag:"Lesson 6.3",
    title:"Binomial Theorem",
    sub:"Use nCr for coefficients; watch signs with (x − y)^n.",
    steps:[
      ()=>stepInfo(`<div><div class="badge">Concept</div><p class="tiny muted">(a+b)^n = Σ C(n,r) a^{n-r} b^r. Middle term(s) come from the middle of row n in Pascal’s Triangle. For (x−y)^n, signs alternate.</p></div>`),
      ()=>stepMultiInputs({
        title:"Expand (x − 2)^3 using Binomial Theorem",
        fields:[
          {label:"List coefficients from row 3", key:"c", placeholder:"1,3,3,1",
            validate:(v)=> v.replace(/\s+/g,'').replace(/，/g,',')==="1,3,3,1" || "Row 3: 1, 3, 3, 1"},
          {label:"Write the final expansion", key:"f",
           validate:(v)=> samePoly(v, [{coef:1,pow:3},{coef:-6,pow:2},{coef:12,pow:1},{coef:-8,pow:0}]) || "Should be x^3 − 6x^2 + 12x − 8"},
        ],
        onPassNote:"Chef’s kiss."
      }),
      ()=>stepMultiInputs({
        title:"Find the middle term of (a + b)^8 without expanding",
        fields:[
          {label:"Which term number(s) are middle for n=8? (1-indexed)", key:"t",
            placeholder:"5th", validate:(v)=>/5(th)?/i.test(v) || "It’s the 5th term"},
          {label:"Coefficient (nCr)", key:"coef",
            validate:(v)=>Number(v)===70||"Coefficient is 70 (8C4)"},
          {label:"Power of a in that term", key:"pa", validate:(v)=>Number(v)===4||"a power is 4"},
          {label:"Power of b in that term", key:"pb", validate:(v)=>Number(v)===4||"b power is 4"},
        ],
        onPassNote:"Middle term = 70 a^4 b^4"
      }),
    ]
  },
  {
    id:"factor",
    tag:"Lesson 6.4",
    title:"Factoring Polynomials",
    sub:"Try GCF → special pattern (squares/cubes) → grouping. Then solve with zero-product.",
    steps:[
      ()=>stepInfo(`<div><div class="badge">Concept</div><p class="tiny muted">GCF first. Then: a^2−b^2=(a+b)(a−b); a^3±b^3=(a±b)(a^2∓ab+b^2). For 4-term polynomials, group pairs to reveal a common binomial.</p></div>`),
      ()=>stepMultiInputs({
        title:"Factor out the GCF: 2x^3 − 20x",
        fields:[
          {label:"GCF", key:"g", validate:(v)=> v.replace(/\s+/g,'').toLowerCase()==="2x" || "GCF is 2x"},
          {label:"Remaining factor", key:"rem",
           validate:(v)=> samePoly(v, [{coef:1,pow:2},{coef:-10,pow:0}]) || "Inside is x^2 − 10"},
        ],
        onPassNote:"2x(x^2 − 10). Over reals, x^2 − 10 is irreducible; over irrationals it’s (x − √10)(x + √10)."
      }),
      ()=>stepMultiInputs({
        title:"Sum of cubes: 27x^3 + 64",
        fields:[
          {label:"Identify a and b", key:"ab",
            placeholder:"a=3x, b=4",
            validate:(v)=> v.replace(/\s+/g,'').toLowerCase()==="a=3x,b=4" || "a=3x, b=4"},
          {label:"Factorization", key:"fac",
            validate:(v)=> v.replace(/\s+/g,'').toLowerCase()==="(3x+4)(9x^2-12x+16)" || "Should be (3x + 4)(9x^2 − 12x + 16)"},
        ]
      }),
      ()=>stepMultiInputs({
        title:"Grouping: x^3 − x^2 + x − 1",
        fields:[
          {label:"Group in pairs & factor each", key:"grp",
            placeholder:"x^2(x−1) + 1(x−1)",
            validate:(v)=> v.replace(/\s+/g,'').toLowerCase()==="x^2(x-1)+1(x-1)" || "x^2(x−1) + 1(x−1)"},
          {label:"Common binomial × leftover", key:"final",
            validate:(v)=> v.replace(/\s+/g,'').toLowerCase()==="(x-1)(x^2+1)" || "Final: (x − 1)(x^2 + 1)"},
        ],
        onPassNote:"That clean factor reveal 🧼"
      }),
    ]
  },
  {
    id:"quiz",
    tag:"Practice",
    title:"Adaptive Quizzes (Polynomials)",
    sub:"Starts simple, levels up. 3 tries → step-by-step teaching.",
    steps:[
      ()=> {
        const d=document.createElement("div"); d.className="step";
        d.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="badge">Adaptive Quiz</div>
              <div class="tiny muted">Earn streaks to level up. 3 wrong tries auto-shows a breakdown.</div>
            </div>
            <div class="row">
              <span class="chip">Level: <strong id="qLevel">1</strong></span>
              <span class="chip">Q <strong id="qNum">1</strong> / <span id="qTotal">10</span></span>
              <span class="chip">Attempts left: <strong id="qAttempts">3</strong></span>
              <span class="chip">Streak: <strong id="qStreak">0</strong></span>
            </div>
          </div>
          <div class="hr"></div>
          <div id="qPrompt" style="margin:8px 0;font-weight:600"></div>
          <div id="qChoices" class="row"></div>
          <div class="hr"></div>
          <div id="qFeedback" class="tiny muted"></div>
          <div id="qTeach"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="qNext" disabled>Next Question ▶</button>
            <button class="btn ghost" id="qReset">Restart Quiz</button>
          </div>
        `;

        const TOTAL = 10;
        const state = {
          level: (progress.quiz?.level)||1,
          qIndex: 0,
          attempts: 3,
          streak: 0,
          corrects: 0,
          current: null
        };

        const qLevel = d.querySelector("#qLevel");
        const qNum = d.querySelector("#qNum");
        const qTotal = d.querySelector("#qTotal");
        const qAttempts = d.querySelector("#qAttempts");
        const qStreak = d.querySelector("#qStreak");
        const qPrompt = d.querySelector("#qPrompt");
        const qChoices = d.querySelector("#qChoices");
        const qFeedback = d.querySelector("#qFeedback");
        const qTeach = d.querySelector("#qTeach");
        const qNext = d.querySelector("#qNext");
        const qReset = d.querySelector("#qReset");
        qTotal.textContent = TOTAL;

        function saveQuiz(){
          progress.quiz = {level:state.level, last:Date.now()};
          saveProgress();
        }
        function renderTeach(breakdown){
          qTeach.innerHTML = "";
          const wrap=document.createElement("div");
          wrap.className="step";
          wrap.innerHTML = `<div class="badge">Let’s break it down</div>`;
          breakdown.forEach((line,i)=>{
            const p=document.createElement("div");
            p.className="tiny";
            p.style.marginTop="6px";
            p.innerHTML = `${i+1}. ${line}`;
            wrap.appendChild(p);
          });
          qTeach.appendChild(wrap);
        }
        function adaptAfter(correct){
          if(correct){
            state.streak += 1;
            state.corrects += 1;
            if(state.streak>=2){ state.level = Math.min(4, state.level+1); state.streak=0; }
          }else{
            state.streak = Math.max(0, state.streak-1);
          }
          saveQuiz();
        }
        function pickNextLevelOnAdvance(lastWasFail){
          if(lastWasFail){
            state.level = Math.max(1, state.level-1);
          }
        }
        function renderQuestion(){
          qTeach.innerHTML=""; qFeedback.textContent=""; qNext.disabled = true;
          state.attempts = 3; qAttempts.textContent = state.attempts;
          qLevel.textContent = state.level; qNum.textContent = (state.qIndex+1);
          const Q = makeQuestion(state.level); state.current = Q;
          qPrompt.textContent = Q.prompt; qChoices.innerHTML = "";
          Q.choices.forEach((choice, i)=>{
            const btn=document.createElement("button"); btn.className="btn"; btn.textContent = choice;
            btn.onclick = ()=>{
              if(state.attempts<=0) return;
              if(i===Q.correctIndex){
                qFeedback.textContent = "that’s it — nailed it ✅";
                qFeedback.className="tiny ok";
                qNext.disabled=false;
                adaptAfter(true);
                [...qChoices.children].forEach(b=>b.disabled=true);
              }else{
                state.attempts -= 1; qAttempts.textContent = state.attempts;
                qFeedback.textContent = state.attempts>0 ? "not quite — try another option" : "that was your 3rd attempt";
                qFeedback.className = state.attempts>0 ? "tiny bad" : "tiny warn";
                if(state.attempts===0){
                  renderTeach(Q.breakdown);
                  [...qChoices.children].forEach((b,idx)=>{ if(idx===Q.correctIndex){ b.classList.add("correct"); } b.disabled=true; });
                  qNext.disabled=false;
                  adaptAfter(false);
                }
              }
            };
            qChoices.appendChild(btn);
          });
        }
        qNext.onclick = ()=>{
          const failed = state.attempts===0;
          pickNextLevelOnAdvance(failed);
          if(state.qIndex < TOTAL-1){
            state.qIndex += 1; renderQuestion();
          }else{
            qPrompt.innerHTML = `Quiz finished. Score: <strong>${state.corrects}/${TOTAL}</strong>`;
            qChoices.innerHTML = "";
            qFeedback.textContent = (state.corrects<=4)
              ? "no stress — we’ll keep building your base. want a rematch?"
              : (state.corrects<=7)
                ? "solid! keep practicing to push up a level."
                : "chef’s kiss. you’re cruising 😎";
            qNext.disabled=true;
          }
        };
        qReset.onclick = ()=>{
          state.level=1; state.qIndex=0; state.attempts=3; state.streak=0; state.corrects=0;
          qStreak.textContent = state.streak; saveQuiz(); renderQuestion(); notify("Quiz reset");
        };
        const obs = new MutationObserver(()=>{ qStreak.textContent = state.streak; });
        obs.observe(d, {subtree:true, childList:true});
        renderQuestion();
        return {el:d, check:()=>true};
      }
    ]
  }
];

/* ====== UI wiring ====== */
function renderNav(){
  nav.innerHTML = "";
  MODULES.forEach((m, idx)=>{
    const doneCount = (progress[m.id]?.done||0);
    const total = m.steps.length;
    const pct = Math.round(100*doneCount/total);
    const item=document.createElement("div");
    item.className="row";
    item.style.cursor="pointer";
    item.style.justifyContent="space-between";
    item.style.padding="10px 8px";
    item.style.borderRadius="10px";
    item.onmouseenter=()=> item.style.background="#0c1220";
    item.onmouseleave=()=> item.style.background="transparent";
    item.onclick=()=> loadModule(m.id);
    item.innerHTML = `
      <div>
        <div><strong>${idx+1}. ${m.title}</strong></div>
        <div class="tiny muted">${m.sub}</div>
        <div class="row tiny muted" style="margin-top:6px;gap:8px">
          <span class="badge">${m.tag}</span>
          <span>${doneCount}/${total} steps</span>
        </div>
      </div>
      <div style="width:72px">
        <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
        <div class="tiny muted" style="text-align:right;margin-top:4px">${pct}%</div>
      </div>
    `;
    nav.appendChild(item);
  });
  updateOverall();
}
function updateOverall(){
  const totals = MODULES.map(m=>({n:m.steps.length, d:(progress[m.id]?.done||0)}));
  const n = totals.reduce((a,b)=>a+b.n,0);
  const d = totals.reduce((a,b)=>a+b.d,0);
  const pct = n? Math.round(100*d/n): 0;
  overallPct.textContent = `${pct}% Complete`;
}
let current = null;
function loadModule(id){
  const m = MODULES.find(x=>x.id===id) || MODULES[0];
  current = m;
  unitTitle.textContent = m.title;
  unitSub.textContent = m.sub;
  unitTag.textContent = m.tag;
  stepsBox.innerHTML="";
  (progress[m.id] ||= {index:0, done:0});
  const idx = progress[m.id].index||0;
  unitCount.textContent = progress[m.id].done||0;
  unitBar.style.width = Math.round(100*(progress[m.id].done||0)/m.steps.length)+"%";
  renderStepsUntil(idx);
}
function renderStepsUntil(i){
  stepsBox.innerHTML="";
  const m=current;
  for(let k=0;k<=i && k<m.steps.length;k++){
    const s = m.steps[k]();
    s._checker = s.check;
    stepsBox.appendChild(s.el);
  }
  updateButtons();
}
function updateButtons(){
  const m=current;
  const idx = progress[m.id].index||0;
  nextBtn.textContent = (idx>=m.steps.length-1) ? "Finish Module" : "Next ▶";
}
nextBtn.onclick = ()=>{
  const m=current;
  const idx = progress[m.id].index||0;
  const checker = stepsBox.lastChild? stepsBox.lastChild._checker : null;
  if(MODE==="Learn" && checker){
    const ok = checker();
    if(!ok){ notify("Do the step first 👀"); return; }
  }
  if(idx < m.steps.length-1){
    progress[m.id].index = idx+1;
    progress[m.id].done = Math.max(progress[m.id].done||0, idx+1);
    saveProgress();
    renderStepsUntil(progress[m.id].index);
    unitCount.textContent = progress[m.id].done;
    unitBar.style.width = Math.round(100*progress[m.id].done/m.steps.length)+"%";
  }else{
    notify("Module complete — nice ✨");
  }
  updateButtons();
};
resetBtn.onclick = ()=>{
  if(!current) return;
  progress[current.id] = {index:0, done:0};
  saveProgress();
  loadModule(current.id);
  notify("Module reset");
};

renderNav();
loadModule(MODULES[0].id);
</script>
</body>
</html>
